{% extends 'generic/object_list.html' %}

{% block javascript %}
  {{ block.super }}
  <script>
    // Обработчик клика для раскрытия строк таблицы
    document.addEventListener("click", function(e) {
      const btn = e.target.closest(".toggle-details");
      if (!btn) return;
      
      const table = btn.closest("table");
      if (!table) return;
      
      e.preventDefault();
      e.stopPropagation();

      const apkId = btn.dataset.apk;
      const tr = btn.closest("tr");
      if (!tr) return;

      // Если уже открыт — просто убрать
      const nextRow = tr.nextElementSibling;
      if (nextRow && nextRow.classList.contains("apk-details")) {
        nextRow.remove();
        btn.innerHTML = '<i class="mdi mdi-chevron-down"></i>';
        return;
      }

      // Закрыть предыдущие открытые
      const openRows = table.querySelectorAll(".apk-details");
      openRows.forEach(r => r.remove());
      const openBtns = table.querySelectorAll(".toggle-details i");
      openBtns.forEach(i => {
        if (i.classList.contains("mdi-chevron-up")) {
          i.classList.replace("mdi-chevron-up", "mdi-chevron-down");
        }
      });

      // Получаем количество видимых колонок из заголовка
      const headerRow = table.querySelector("thead tr");
      const columnCount = headerRow ? headerRow.children.length : tr.children.length;

      // Вставляем новую строку с данными
      const detailsRow = document.createElement("tr");
      detailsRow.classList.add("apk-details");
      const detailsCell = document.createElement("td");
      detailsCell.colSpan = columnCount;
      detailsCell.style.padding = "0";
      detailsCell.innerHTML = `
          <div class="card-body bg-primary-subtle border-start border-4 border-primary" style="margin: 0.5rem; padding: 1rem;">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="d-flex align-items-start">
                  <i class="mdi mdi-ethernet text-primary me-2 fs-5"></i>
                  <div>
                    <div class="text-muted small mb-1">Кол-во портов</div>
                    <div class="fs-5 fw-semibold">${tr.dataset.portsCount || '—'}</div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-start">
                  <i class="mdi mdi-network text-primary me-2 fs-5"></i>
                  <div>
                    <div class="text-muted small mb-1">Тип портов</div>
                    <div class="fs-5 fw-semibold">${tr.dataset.portsType || '—'}</div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="d-flex align-items-start">
                  <i class="mdi mdi-speedometer text-primary me-2 fs-5"></i>
                  <div>
                    <div class="text-muted small mb-1">Ёмкость лицензии</div>
                    <div class="fs-5 fw-semibold">${tr.dataset.capacity || '—'} <span class="text-muted fs-6">Гбит/с</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      detailsRow.appendChild(detailsCell);
      tr.insertAdjacentElement("afterend", detailsRow);
      
      const icon = btn.querySelector("i");
      if (icon) {
        icon.classList.replace("mdi-chevron-down", "mdi-chevron-up");
      } else {
        btn.innerHTML = '<i class="mdi mdi-chevron-up"></i>';
      }
    });
  </script>
{% endblock %}
